from googlesearch import search
from discord.ext import commands
import discord
from urllib.request import urlopen
from bs4 import BeautifulSoup

class ExploitDB(commands.Cog):
	def __init__(self,bot):
		self.bot=bot
	
	@commands.command(name="exploitdb", help="A tool to find known exploits in an application.")
	async def getExploit(self,ctx,query,results=3):
		embed=discord.Embed(title="ExploitDB Search",description=f"Searching for {results} exploit(s) for '{query}'",color=0x00FFFF)
		message=await ctx.send(embed=embed)
		search_query=f"{query} site:www.exploit-db.com"
		search_results = search(search_query, tld="com", stop=results)
		temp=[result for result in search_results]
		if len(temp)!=0:
			print("Found Exploits")
			embed=discord.Embed(title="ExploitDB Search",description=f"Found exploits for '{query}'",color=0x00FF00)
			for result in temp:
				soup = BeautifulSoup(urlopen(result),'html5lib')
				title=soup.title.get_text()
				embed.add_field(name="Title:",value=title, inline=False)
				embed.add_field(name="URL:",value=result, inline=False)
				await message.edit(content=ctx.author.mention,embed=embed)
		else:
			embed=discord.Embed(title="ExploitDB Search",description=f"No exploit found for '{query}'",color=0xFF0000)
			await message.edit(content=ctx.author.mention,embed=embed)

		print("Search Complete!")

def setup(bot):
	bot.add_cog(ExploitDB(bot))